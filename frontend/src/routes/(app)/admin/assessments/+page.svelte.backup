<script>
  import * as Dialog from '$lib/components/ui/dialog';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  import { Label } from '$lib/components/ui/label';
  import * as Select from '$lib/components/ui/select';
  import { Badge } from '$lib/components/ui/badge';
  import {
    Plus,
    Edit2,
    Trash2,
    ClipboardList,
    FileText,
    Type,
    Upload,
    ChevronRight
  } from 'lucide-svelte';
  import { PUBLIC_API_URL } from '$env/static/public';
  import { ASSESSMENT_TYPES } from '$lib/types/assessment.types';

  const { data, form } = $props();

  console.log(data.assessments);

  const FIELD_TYPES = [
    { value: 0, label: 'Short Answer', icon: Type },
    { value: 1, label: 'Long Answer', icon: FileText },
    { value: 2, label: 'File Upload', icon: Upload }
  ];

  // Modal states
  let showConfirm = $state(false);
  let confirmText = $state('');
  /** @type {(() => Promise<void>) | null} */
  let confirmAction = $state(null);

  // Create assessment state
  let showCreateTypeModal = $state(false);
  let createName = $state('');
  let selectedAssessmentType = $state('Technology');

  // Fields modal state
  let showFieldsModal = $state(false);
  let selectedAssessment = $state(null);
  let fields = $state([]);

  // Field edit state
  let showFieldEditModal = $state(false);
  let editingField = $state({ description: '', answerType: 0, order: 1 });

  /** @type {Set<string>} */
  let expandedTypes = $state(new Set());

  async function refreshAssessments() {
    window.location.reload();
  }

  function openConfirm(text, action) {
    confirmText = text;
    confirmAction = action;
    showConfirm = true;
  }

  function toggleType(typeName) {
    if (expandedTypes.has(typeName)) {
      expandedTypes.delete(typeName);
    } else {
      expandedTypes.add(typeName);
    }
    expandedTypes = new Set(expandedTypes);
  }

  async function openAssessmentFields(assessment) {
    selectedAssessment = assessment;
    await fetchFields(assessment.id);
    showFieldsModal = true;
  }

  async function fetchFields(assessmentId) {
    const res = await fetch(`${PUBLIC_API_URL}/assessments/${assessmentId}/fields`, {
      headers: { Authorization: `Bearer ${data.access}` }
    });
    if (!res.ok) {
      console.error('Failed to load fields', res.status, await res.text());
      alert(`Failed to load fields (${res.status}).`);
      return;
    }
    fields = await res.json();
  }

  function openFieldModal(field = null) {
    if (field) {
      editingField = { ...field };
    } else {
      const maxOrder = fields.length > 0 ? Math.max(...fields.map(f => f.order)) : 0;
      editingField = { description: '', answerType: 0, order: numOrder + 1 };
    }
    showFieldsModal = false; // Close fields modal
    showFieldEditModal = true;
  }

  async function saveField() {
    if (!selectedAssessment || !editingField.description?.trim()) return;

    const payload = {
      description: editingField.description.trim(),
      answerType: Number(editingField.answerType),
      order: Number(editingField.order)
    };

    let res;
    if (editingField.id) {
      // Update existing field
      res = await fetch(`${PUBLIC_API_URL}/assessments/fields/${editingField.id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${data.access}`
        },
        body: JSON.stringify(payload)
      });
    } else {
      // Create new field
      res = await fetch(`${PUBLIC_API_URL}/assessments/${selectedAssessment.id}/fields`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${data.access}`
        },
        body: JSON.stringify(payload)
      });
    }

    if (!res.ok) {
      console.error('Save field failed', res.status, await res.text());
      alert(`Save field failed (${res.status}).`);
      return;
    }

    showFieldEditModal = false;
    await fetchFields(selectedAssessment.id);
    await refreshAssessments();
  }

  async function deleteField(fieldId) {
    const res = await fetch(`${PUBLIC_API_URL}/assessments/fields/${fieldId}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${data.access}` }
    });
    if (!res.ok) {
      console.error('Delete field failed', res.status, await res.text());
      alert(`Delete field failed (${res.status}).`);
      return;
    }
    await fetchFields(selectedAssessment.id);
    await refreshAssessments();
  }

  async function createAssessment() {
    if (!createName.trim()) return;
    const res = await fetch(`${PUBLIC_API_URL}/assessments`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${data.access}`
      },
      body: JSON.stringify({
        name: createName.trim(),
        assessmentType: selectedAssessmentType.trim()
      })
    });
    if (!res.ok) {
      console.error('Create assessment failed', res.status, await res.text());
      alert(`Create assessment failed (${res.status}). Check backend logs.`);
      return;
    }
    createName = '';
    selectedAssessmentType = 'Technology';
    showCreateTypeModal = false;
    await refreshAssessments();
  }
</script>

<div class="space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold tracking-tight">Assessments</h1>
      <p class="mt-1 text-sm text-muted-foreground">
        View all assessments organized by type
      </p>
    </div>
    <Button onclick={() => (showCreateTypeModal = true)} class="gap-2">
      <Plus class="h-4 w-4" />
      Add Assessment
    </Button>
  </div>

  <div class="rounded-lg border bg-card shadow-sm">
    <div class="bg-muted/50 flex items-center justify-between border-b px-6 py-4">
      <h2 class="font-semibold">All Assessments by Type</h2>
      <span class="text-xs text-muted-foreground">
        {Object.keys(data.assessments || {}).length} types
      </span>
    </div>

    <div class="divide-y">
      {#each ASSESSMENT_TYPES as typeName}
        {@const assessments = data.assessments?.[typeName] || []}
        {@const isExpanded = expandedTypes.has(typeName)}

        <div>
          <!-- Type Header (Collapsible) -->
          <button
            class="hover:bg-muted/50 group flex w-full items-center justify-between px-6 py-4 text-left transition-colors"
            onclick={() => toggleType(typeName)}
          >
            <div class="flex items-center gap-3">
              <div class="bg-flutter-blue/10 group-hover:bg-flutter-blue/20 rounded-lg p-2 transition-colors">
                <ClipboardList class="text-flutter-blue h-5 w-5" />
              </div>
              <div>
                <span class="font-medium">{typeName}</span>
                <span class="ml-2 text-xs text-muted-foreground">
                  {assessments.length}
                  {assessments.length === 1 ? 'assessment' : 'assessments'}
                </span>
              </div>
            </div>
            <ChevronRight
              class="h-4 w-4 text-muted-foreground transition-transform {isExpanded ? 'rotate-90' : ''}"
            />
          </button>

          <!-- Assessments List (Collapsible Content) -->
          {#if isExpanded}
            <div class="bg-muted/20 border-t px-6 py-4">
              {#if assessments.length > 0}
                <div class="space-y-2">
                  {#each assessments as assessment}
                    <button
                      class="hover:bg-card/80 hover:border-flutter-blue/30 w-full rounded-lg border bg-card p-4 text-left transition-colors"
                      onclick={() => openAssessmentFields(assessment)}
                    >
                      <div class="flex items-start gap-3">
                        <div class="rounded-lg bg-muted p-2">
                          <ClipboardList class="h-4 w-4 text-muted-foreground" />
                        </div>
                        <div class="min-w-0 flex-1">
                          <p class="text-sm font-medium">{assessment.name}</p>
                          <div class="mt-1 flex items-center gap-2">
                            <Badge variant="secondary" class="text-xs">
                              {assessment.fieldsCount}
                              {assessment.fieldsCount === 1 ? 'field' : 'fields'}
                            </Badge>
                            <span class="text-xs text-muted-foreground">ID: {assessment.id}</span>
                          </div>
                        </div>
                        <ChevronRight class="h-4 w-4 text-muted-foreground" />
                      </div>
                    </button>
                  {/each}
                </div>
              {:else}
                <div class="flex flex-col items-center justify-center py-8 text-center">
                  <div class="mb-3 rounded-full bg-muted p-3">
                    <FileText class="h-6 w-6 text-muted-foreground" />
                  </div>
                  <p class="text-sm font-medium text-muted-foreground">
                    No assessments for {typeName}
                  </p>
                  <p class="mt-1 text-xs text-muted-foreground">
                    Add assessments to this type to get started
                  </p>
                </div>
              {/if}
            </div>
          {/if}
        </div>
      {/each}
    </div>
  </div>
</div>

<!-- Fields Modal -->
{#if selectedAssessment}
  <Dialog.Root open={showFieldsModal} onOpenChange={(v) => (showFieldsModal = v)}>
    <Dialog.Content class="max-h-[90vh] max-w-[1000px] overflow-hidden p-0">
      <!-- Header Section -->
      <div class="from-flutter-blue/5 border-b bg-gradient-to-r to-transparent px-6 py-5">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="mb-2 flex items-center gap-3">
              <div class="bg-flutter-blue/10 rounded-lg p-2.5">
                <ClipboardList class="text-flutter-blue h-5 w-5" />
              </div>
              <div>
                <Dialog.Title class="text-2xl font-bold">{selectedAssessment.name}</Dialog.Title>
                <Dialog.Description class="mt-1">
                  Manage fields for this assessment
                </Dialog.Description>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Content Section -->
      <div class="max-h-[calc(90vh-200px)] overflow-y-auto px-6 py-6">
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div class="bg-flutter-blue h-1 w-1 rounded-full"></div>
              <div>
                <h3 class="text-sm font-bold uppercase tracking-wider text-muted-foreground">
                  Fields
                </h3>
                <p class="mt-0.5 text-xs text-muted-foreground">
                  {fields.length} {fields.length === 1 ? 'field' : 'fields'} defined
                </p>
              </div>
            </div>
            <Button onclick={() => openFieldModal()} class="shadow-sm gap-2">
              <Plus class="h-4 w-4" />
              Add Field
            </Button>
          </div>

          <div class="space-y-3">
            {#each fields as field, index}
              {@const FieldIcon = FIELD_TYPES.find((t) => t.value === field.answerType)?.icon ?? FileText}
              <div class="hover:border-flutter-blue/30 group relative overflow-hidden rounded-xl border bg-card shadow-sm transition-all hover:shadow-md">
                <div class="bg-flutter-blue/20 group-hover:bg-flutter-blue absolute bottom-0 left-0 top-0 w-1 transition-all"></div>
                <div class="p-5 pl-6">
                  <div class="flex items-start justify-between gap-4">
                    <div class="min-w-0 flex-1">
                      <div class="mb-3 flex items-center gap-3">
                        <div class="group-hover:bg-flutter-blue/10 rounded-lg bg-muted p-2 transition-colors">
                          <FieldIcon class="group-hover:text-flutter-blue h-4 w-4 text-muted-foreground transition-colors" />
                        </div>
                        <div class="min-w-0 flex-1">
                          <div class="flex items-center gap-2">
                            <span class="text-xs font-medium text-muted-foreground">Field {field.order}</span>
                          </div>
                          <h4 class="truncate text-base font-semibold">{field.description}</h4>
                        </div>
                      </div>
                      <div class="flex items-center gap-2">
                        <Badge variant="secondary" class="text-xs font-medium">
                          {FIELD_TYPES.find((t) => t.value === field.answerType)?.label ?? `Type ${field.answerType}`}
                        </Badge>
                      </div>
                    </div>
                    <div class="flex shrink-0 gap-2">
                      <Button
                        size="sm"
                        variant="outline"
                        onclick={() => openFieldModal(field)}
                        class="h-9 gap-2"
                      >
                        <Edit2 class="h-3.5 w-3.5" />
                        Edit
                      </Button>
                      <Button
                        size="sm"
                        variant="destructive"
                        onclick={() => openConfirm(
                          'Remove this field? This action cannot be undone.',
                          () => deleteField(field.id)
                        )}
                        class="h-9 gap-2"
                      >
                        <Trash2 class="h-3.5 w-3.5" />
                        Remove
                      </Button>
                    </div>
                  </div>
                </div>
              </div>
            {/each}

            {#if !fields.length}
              <div class="bg-muted/30 hover:bg-muted/50 flex flex-col items-center justify-center rounded-xl border-2 border-dashed py-16 text-center transition-colors">
                <div class="mb-4 rounded-full bg-muted p-4">
                  <FileText class="h-8 w-8 text-muted-foreground" />
                </div>
                <p class="mb-1 text-base font-semibold text-foreground">No fields defined yet</p>
                <p class="mb-4 max-w-sm text-sm text-muted-foreground">
                  Add fields to collect information for this assessment
                </p>
                <Button onclick={() => openFieldModal()} class="gap-2">
                  <Plus class="h-4 w-4" />
                  Add Your First Field
                </Button>
              </div>
            {/if}
          </div>
        </div>
      </div>

      <!-- Footer Section -->
      <div class="bg-muted/30 border-t px-6 py-4">
        <div class="flex items-center justify-between">
          <p class="text-xs text-muted-foreground">Changes are saved automatically</p>
          <Button variant="outline" onclick={() => (showFieldsModal = false)} class="gap-2">
            Close
          </Button>
        </div>
      </div>
    </Dialog.Content>
  </Dialog.Root>
{/if}

<!-- Field Edit Modal -->
<Dialog.Root open={showFieldEditModal} onOpenChange={(v) => (showFieldEditModal = v)}>
  <Dialog.Content class="sm:max-w-md">
    <Dialog.Header>
      <Dialog.Title>{editingField?.id ? 'Edit' : 'Add'} Field</Dialog.Title>
      <Dialog.Description>Define how this field should appear and behave</Dialog.Description>
    </Dialog.Header>

    <div class="space-y-4 pt-4">
      <div class="grid gap-2">
        <Label for="fieldDescription">Field Description</Label>
        <Input
          id="fieldDescription"
          placeholder="Enter field description"
          bind:value={editingField.description}
        />
      </div>

      <div class="grid gap-2">
        <Label>Field Type</Label>
        <Select.Root type="single" bind:value={editingField.answerType}>
          <Select.Trigger class="w-full">
            {#snippet children()}
              {@const SelectedIcon = FIELD_TYPES.find((t) => t.value === Number(editingField.answerType))?.icon ?? FileText}
              <div class="flex items-center gap-2">
                <SelectedIcon class="h-4 w-4" />
                {FIELD_TYPES.find((t) => t.value === Number(editingField.answerType))?.label ?? 'Select type'}
              </div>
            {/snippet}
          </Select.Trigger>
          <Select.Content>
            {#each FIELD_TYPES as t}
              {@const Icon = t.icon}
              <Select.Item value={String(t.value)}>
                {#snippet children()}
                  <div class="flex items-center gap-2">
                    <Icon class="h-4 w-4" />
                    {t.label}
                  </div>
                {/snippet}
              </Select.Item>
            {/each}
          </Select.Content>
        </Select.Root>
      </div>

      <div class="grid gap-2">
        <Label for="fieldOrder">Order</Label>
        <Input
          id="fieldOrder"
          type="number"
          min="1"
          placeholder="Field order"
          bind:value={editingField.order}
        />
      </div>
    </div>

    <Dialog.Footer class="mt-6">
      <Button variant="outline" onclick={() => (showFieldEditModal = false)}>Cancel</Button>
      <Button onclick={saveField} disabled={!editingField.description?.trim()}>
        {editingField?.id ? 'Update' : 'Create'} Field
      </Button>
    </Dialog.Footer>
  </Dialog.Content>
</Dialog.Root>

<!-- Confirm Dialog -->
<Dialog.Root open={showConfirm} onOpenChange={(v) => (showConfirm = v)}>
  <Dialog.Content class="sm:max-w-md">
    <Dialog.Header>
      <Dialog.Title>Confirm Action</Dialog.Title>
      <Dialog.Description class="pt-2">{confirmText}</Dialog.Description>
    </Dialog.Header>
    <Dialog.Footer class="mt-6">
      <Button variant="outline" onclick={() => (showConfirm = false)}>Cancel</Button>
      <Button
        variant="destructive"
        onclick={async () => {
          if (confirmAction) {
            await confirmAction();
          }
          showConfirm = false;
        }}
      >
        Confirm
      </Button>
    </Dialog.Footer>
  </Dialog.Content>
</Dialog.Root>

<!-- Create Assessment Modal -->
<Dialog.Root open={showCreateTypeModal} onOpenChange={(v) => (showCreateTypeModal = v)}>
  <Dialog.Content class="sm:max-w-md">
    <Dialog.Header>
      <Dialog.Title>Create New Assessment</Dialog.Title>
      <Dialog.Description>Add a new assessment to a specific type</Dialog.Description>
    </Dialog.Header>

    <div class="space-y-4 pt-4">
      <div class="grid gap-2">
        <Label for="createName">Assessment Name</Label>
        <Input
          id="createName"
          bind:value={createName}
          placeholder="e.g., Product Viability"
        />
      </div>

      <div class="grid gap-2">
        <Label for="assessmentType">Assessment Type</Label>
        <Select.Root type="single" bind:value={selectedAssessmentType}>
          <Select.Trigger class="w-full">
            {#snippet children()}
              <div class="flex items-center gap-2">
                <ClipboardList class="h-4 w-4" />
                <span>{selectedAssessmentType}</span>
              </div>
            {/snippet}
          </Select.Trigger>
          <Select.Content>
            {#each ASSESSMENT_TYPES as assessmentType}
              <Select.Item value={assessmentType}>
                {#snippet children()}
                  <div class="flex items-center gap-2">
                    <ClipboardList class="h-4 w-4" />
                    <span>{assessmentType}</span>
                  </div>
                {/snippet}
              </Select.Item>
            {/each}
          </Select.Content>
        </Select.Root>
      </div>
    </div>

    <Dialog.Footer class="mt-6">
      <Button
        variant="outline"
        onclick={() => {
          showCreateTypeModal = false;
          createName = '';
        }}
      >
        Cancel
      </Button>
      <Button onclick={createAssessment} disabled={!createName.trim()}>
        Create Assessment
      </Button>
    </Dialog.Footer>
  </Dialog.Content>
</Dialog.Root>
